<!DOCTYPE html>
<!--
	ustora by freshdesignweb.com
	Twitter: https://twitter.com/freshdesignweb
	URL: https://www.freshdesignweb.com/ustora/
-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="layout/head_link::header('E Mart')"/>
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">

    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
            integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
            crossorigin="anonymous"
    />
</head>
<body>

<th:block th:replace="layout/site_header::header"/>
<th:block th:replace="layout/site_header::site_brand"/>
<th:block th:replace="layout/site_header::mainmeu"/>

<div class="single-product-area position-relative">
    <div class="row  position-absolute" style="display: none" id="cart-container">

        <div class="card card-body">
            <div class="card-body p-4">

                <div class="row">
                    <h5 class="mb-3"><a href="#!" class="text-body"><i
                            class="fas fa-long-arrow-alt-left me-2"></i>Continue shopping</a></h5>
                    <hr>

                    <div class="row mb-4" id="cartHeader" style="display: none">
                        <div class="col-lg-6">
                            <p class="mb-1">Shopping cart</p>
                            <p class="mb-0">You have <span id="orderDetailQuantity">4</span> items in your cart</p>
                        </div>
                        <div class="col-lg-6">
                            <p class="mb-0"><span class="text-muted">Sort by:</span>
                                <a href="#!" class="text-body">price
                                    <i class="fas fa-angle-down mt-1"></i>
                                </a>
                            </p>
                        </div>
                    </div>

                    <div id="cartDetails">

                    </div>
                    <div class="card mb-3" id="cartFooter" style="display: none;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div class="col-lg-4 text-end"><p class="h1">Total:</p></div>
                                <div class="col-lg-4 text-end"><p class="h1" id="cartTotalAmount">$500.00</p></div>
                                <div class="col-lg-4">
                                    <button class="btn btn-lg btn-primary float-end">Check out</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="zigzag-bottom"></div>
    <div class="container">
        <div class="row" id="prodContainer">
        </div>
        <!--        <div class="row">-->
        <!--            <div class="col-md-12">-->
        <!--                <div class="product-pagination text-center">-->
        <!--                    <nav>-->
        <!--                        <ul class="pagination">-->
        <!--                            <li>-->
        <!--                                <a href="#" aria-label="Previous">-->
        <!--                                    <span aria-hidden="true">&laquo;</span>-->
        <!--                                </a>-->
        <!--                            </li>-->
        <!--                            <li><a href="#">1</a></li>-->
        <!--                            <li><a href="#">2</a></li>-->
        <!--                            <li><a href="#">3</a></li>-->
        <!--                            <li><a href="#">4</a></li>-->
        <!--                            <li><a href="#">5</a></li>-->
        <!--                            <li>-->
        <!--                                <a href="#" aria-label="Next">-->
        <!--                                    <span aria-hidden="true">&raquo;</span>-->
        <!--                                </a>-->
        <!--                            </li>-->
        <!--                        </ul>-->
        <!--                    </nav>-->
        <!--                </div>-->
        <!--            </div>-->
        <!--        </div>-->
    </div>
</div>

<th:block th:replace="layout/site_footer::top"/>
<th:block th:replace="layout/site_footer::bottom"/>

<th:block th:replace="layout/script::all"/>

<script>
    function init() {
        const page = {
            urls: {
                findUserById: AppBase.DOMAIN_SPB_API + "/users",
                getBestSellerProduct: AppBase.DOMAIN_SPB_API + "/products/best_sellers",
                getUserCart: AppBase.DOMAIN_SPB_API + "/carts/user",
                addOneCartDetail:AppBase.DOMAIN_SPB_API + "/carts/add/",
                minusOneCartDetail:AppBase.DOMAIN_SPB_API + "/carts/minus/",
            },
            elements: {},
            loadData: {},
            commands: {},
        };
        page.elements.prodContainer = $("#prodContainer");

        page.elements.cartBtn = $("#cartBtn");
        page.elements.cartContainer = $("#cart-container");

        page.elements.orderDetailQuantity = $("#orderDetailQuantity");
        page.elements.cartDetails = $("#cartDetails");
        page.elements.cartHeader = $("#cartHeader");
        page.elements.cartFooter = $("#cartFooter");
        page.elements.cartTotalAmount = $("#cartTotalAmount");
        page.elements.cartTotalAmountBtn = $("#cartTotalAmountBtn")
        page.elements.cartDetailQuantityBtn = $("#cartDetailQuantityBtn")

        //=======LOAD DATA=========//
        page.loadData.loadAllProducts = () => {
            $.ajax({
                type: "GET",
                url: AppBase.DOMAIN_SPB_API + "/products",
            })
                .done((data) => {
                    $.each(data, (i, item) => {
                        let pCard = page.commands.renderProductCard(item);
                        page.elements.prodContainer.prepend(pCard);
                    })
                })
                .fail((jqXHR) => {
                    console.log(jqXHR)
                })
        }
        page.loadData.loadUserCart = () => {
            return $.ajax({
                type: "GET",
                url: page.urls.getUserCart
            })
                .done((data) => {
                    let {cartDetails, totalAmount} = data;
                    if (cartDetails) {
                        page.elements.cartDetails.text("Add a product to show!")
                        return;
                    }
                    if (totalAmount === 0) return;
                    let count = 0;
                    page.elements.cartDetails.empty();
                    $.each(cartDetails, (i, cartDetail) => {
                        let cartDetailEl = page.commands.renderCartDetail(cartDetail);
                        page.elements.cartDetails.prepend(cartDetailEl);
                        count++;
                    })
                    page.elements.orderDetailQuantity.text(count);
                    page.elements.cartTotalAmount.text("$" + totalAmount);
                    page.elements.cartTotalAmountBtn.text("$" + totalAmount);
                    page.elements.cartDetailQuantityBtn.text(count);
                    page.elements.cartHeader.show();
                    page.elements.cartFooter.show();
                    page.commands.addQuantityBtnClickEvent()
                })
                .fail((jqXHR) => {
                    page.elements.cartHeader.hide();
                    page.elements.cartFooter.hide();
                    switch (jqXHR.status) {
                        case 401:
                            page.elements.cartDetails.text("Please login to see cart details!")
                            break;
                        default:
                            page.elements.cartDetails.text("Some thing went wong, please try again later!");
                    }
                })
        }
        //==========RENDER===============//
        page.commands.renderProductCard = (prod) => {
            let {id, title, price, avatar} = prod;
            let imageUrl = AppBase.BASE_URL_CLOUD_IMAGE + '/' + AppBase.BASE_SHOP_PRODUCT_SCALE_IMAGE + '/' + avatar.fileFolder + '/' + avatar.fileName;
            return `
             <div class="col-md-3 col-sm-6">
                <div class="single-shop-product">
                    <div class="product-upper">
                        <img src="${imageUrl}" alt="">
                    </div>
                    <h2><a href="">${title}</a></h2>
                    <div class="product-carousel-price">
                        <ins>$ ${price}</ins> <del>$ ${price - price * 0.15}</del>
                    </div>
                    <div class="product-option-shop">
                        <a class="btn btn-success addToCartBtn" data-id="${id}">Add to cart</a>
                    </div>
                </div>
            </div>
            `
        }
        page.commands.renderCartDetail = (cartDetail) => {
            let {title, price, quantity, amount, product} = cartDetail;
            let {avatar, id} = product;
            let imageUrl = AppBase.BASE_URL_CLOUD_IMAGE + '/' + AppBase.BASE_CART_PRODUCT_SCALE_IMAGE + '/' + avatar.fileFolder + '/' + avatar.fileName;
            return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between row">
                                <div class="col-lg-7 d-flex flex-row align-items-center " style="font-size: 16px">
                                    <div>
                                        <img
                                                src="${imageUrl}"
                                                class="img-fluid rounded-3" alt="Shopping item"
                                                style="width: 65px;">
                                    </div>
                                    <div class="ms-3">
                                        <h5>${title}</h5>
                                        <p class="small mb-0">${product.description}</p>
                                    </div>
                                </div>
                                <div class="col-lg-5 d-flex flex-row align-items-center">
                                    <span   style="cursor: pointer"
                                            class="border border-1 rounded px-2 mx-2 btn-add"
                                            data-id=${id}>
                                        <i  class="fa fa-plus"></i>
                                    </span>
                                    <input  style="width: 30px;height: 25px"
                                            class="mb-0 text-center border-light"
                                            value="${quantity}"/>
                                    <span   style="cursor: pointer"
                                            class="border border-1 rounded px-2 mx-2 btn-minus"
                                            data-id=${id}>
                                        <i  class="fa fa-minus"></i>
                                    </span>
                                    <div    style="width: 80px;">
                                        <p  class="h3 text-center">$ ${amount}</p>
                                    </div>
                                    <button class="btn btn-sm btn-danger">
                                        <i  class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
        }

        //=========EVENT HANDLER===========//

        page.elements.cartBtn.hover(() => {
            page.elements.cartContainer.show(200)
        })

        page.elements.cartContainer.mouseleave(function () {
            $(this).hide(200);
        })

        page.commands.addQuantityBtnClickEvent = ()=>{
            page.elements.addBtn = $(".btn-add");
            page.elements.minusBtn = $(".btn-minus");

            page.elements.addBtn.off("click");
            page.elements.minusBtn.off("click");

            page.elements.addBtn.on("click", function () {
                let id = $(this).data("id");
                page.commands.addCartDetailQuantity(id);
            });
            page.elements.minusBtn.on("click", function () {
                let id = $(this).data("id");
                page.commands.minusCartDetailQuantity(id);
            });
        }

        page.commands.eventHandler = ()=>{
        }
        //========DATABASE INTERACT=========//

        page.commands.addCartDetailQuantity = (id)=>{
            $.ajax({
                type: "POST",
                url: page.urls.addOneCartDetail + id,
            }).done(()=>{
                page.loadData.loadUserCart();
            }).fail((jqXHR)=>{
                console.log(jqXHR);
            })
        }

        page.commands.minusCartDetailQuantity = (id)=>{
            $.ajax({
                type: "POST",
                url: page.urls.minusOneCartDetail + id,
            }).done(()=>{
                page.loadData.loadUserCart();
            }).fail((jqXHR)=>{
                console.log(jqXHR);
            })
        }






        page.loadData.handleLoadData = () => {
            page.loadData.loadAllProducts();
            page.loadData.loadUserCart();
            page.commands.eventHandler()
        }
        return () => {
            page.loadData.handleLoadData();
        }
    }

    $(() => {
        let Shop = init();
        Shop();
    })
</script>
</body>
</html>